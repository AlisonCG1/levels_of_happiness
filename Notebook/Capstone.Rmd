---
title: "Capstone"
output: html_notebook
---

```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readr)
library(tibble)
library(sf)
library(GGally)
library(corrplot)
```
- The following corresponds to waves on which interviews took place.
```{r}
happiness1990 <- read.table ('../data/WV2_Data_csv_v20180912.csv', sep = ";", header = TRUE, stringsAsFactors = FALSE)
happiness1995 <- read.table ('../data/WV3_Data_csv_v20180912.csv', sep = ";", header = TRUE, stringsAsFactors = FALSE)
happiness1999 <- read.table ('../data/WV4_Data_csv_v20201117.csv', sep = ";", header = TRUE, stringsAsFactors = FALSE)
happiness2005 <- read.table ('../data/WV5_Data_csv_v20180912.csv', sep = ";", header = TRUE, stringsAsFactors = FALSE)
happiness2010 <- read.table ('../data/WV6_Data_csv_v20201117.csv', sep = ";", header = TRUE, stringsAsFactors = FALSE)
happiness2017 <- read.table ('../data/WVS_Cross-National_Wave_7_csv_v5_0.csv', sep = ",", header = TRUE, stringsAsFactors = FALSE)
```

- Population Data
```{r}
GDP <- read.csv('../data/gdp.csv',  header = FALSE)
Total_Population <- read.csv('../data/totalpopulation.csv', header = FALSE)
Poverty <- read.csv('../data/poverty-explorer.csv', header = FALSE)
```

- Geolocation Data
```{r}
countries_code <- read_csv("../data/countries.csv.xls")
world_countries <- read_csv("../data/World_Countries_(Generalized).csv")
regions <- read_csv("../data/worldregions.csv")
country_codes <- read_csv("../data/country_codes.csv")
```

- After reading the data (Poverty, Total Population and GDP), there was some cleaning to do. 
```{r}
colnames(Poverty) <- Poverty[1,]
Poverty <- Poverty[-1, ]
```

```{r}
Poverty
```
```{r}
poverty_transformed <-  Poverty%>%
  transmute(
    Country = Entity, 
   `Number_below_$3.65_a_day` = `Number below $3.65 a day`,
    `Number_below_$6.85_a_day` = `Number below $6.85 a day`,
    `Number_below_$10_a_day` = `Number below $10 a day`,
    Year = Year
  )

poverty_transformed
```
```{r}
poverty_transformed <- poverty_transformed[!(poverty_transformed$Year >= 1969 & poverty_transformed$Year <= 1989), ]
```


```{r}
Total_Population
```

```{r}
colnames(Total_Population) <- Total_Population[3,]
Total_Population <- Total_Population[-3, ]
```

```{r}
# Delete rows with specific values
Total_Population  <- Total_Population[!(Total_Population$"Country Name" == "Data Source" | Total_Population$"Country Name" == "Last Updated Date"), ]
Total_Population
```

```{r}
# Use pivot_longer to reshape the data
population_transformed <- Total_Population %>%
  pivot_longer(cols = `1960`:`2021`,
               names_to = "Year",
               values_to = "Value")

# View the transformed dataframe
print(population_transformed)
```

```{r}
population_transformed <- population_transformed%>%
  transmute(
    Country = `Country Name`,
    CountryCode = `Country Code`, 
    total_population = Value,
    Year = Year
  )

population_transformed
```
```{r}
population_transformed <- population_transformed[!(population_transformed$Year >= 1960 & population_transformed$Year <= 1989), ]
```


```{r}
GDP
```

```{r}
colnames(GDP) <- GDP[2,]
GDP <- GDP[-2, ]
```

```{r}
GDP
```

```{r}
colnames(GDP) <- GDP[2,]
GDP <- GDP[-2, ]
```

```{r}
GDP <- GDP[!(GDP$"Country Name" == "Data Source" | GDP$"Country Name" == "Last Updated Date"), ]
GDP
```
```{r}
# Use pivot_longer to reshape the data
gdp_transformed <- GDP %>%
  pivot_longer(cols = `1960`:`2021`,
               names_to = "Year",
               values_to = "Value")

# View the transformed dataframe
print(gdp_transformed)
```

- Deleting rows that aren't needed.
```{r}
gdp_transformed <- gdp_transformed%>%
  transmute(
    Country = `Country Name`,
    CountryCode = `Country Code`, 
    gdp = Value,
    Year = Year
  )

gdp_transformed 
```

```{r}
gdp_transformed <- gdp_transformed[!(gdp_transformed$Year >= 1960 & gdp_transformed$Year <= 1989), ]
```

```{r}
gdp_transformed
```


- Merging tables. 
```{r}
# Merging the data frames based on 'CountryName'
merged_df <- merge(poverty_transformed, population_transformed, by = c("Country", "Year"))

Population_total <- merge(gdp_transformed, merged_df, by = c("Country", "CountryCode", "Year"))
```

```{r}
Population_total
```

- Data prep. The the second wave of surveys correspond to 1990 to 1994. 
V18 or feeling of happiness is measured:
1 Very happy
2 Quite happy
3 Not very happy
4 Not at all happy
9 Don't know

V96 or Satisfaction with your life is measured:
1 Dissatisfied - 10 Satisfied

V116 or Job satisfaction is measured: 
1 Dissatisfied - 10 Satisfied

V132 or How satisfied are you with the financial situation of your household? is measured: 
1 Dissatisfied - 10 Satisfied

V353 or Sex is measured: 
1 - male
2 female
```{r}
happiness_1990 <- happiness1990%>% 
  transmute(
    CountryCode = V2,
    Feeling_of_happiness = V18,
    Life_satisfaction = V96,
    Financial_satisfaction = V132,
    Sex = V353,
    Age = V355,
    Year = V377)
```

- 1995
```{r}
happiness_1995 <- happiness1995%>% 
  transmute(
    CountryCode = V2,
    Feeling_of_happiness = V10,
    Life_satisfaction = V65,
    Financial_satisfaction = V64,
    Sex = V214,
    Age = V216,
    Year = V238)
```

-1999.
```{r}
happiness_1999 <- happiness1999%>% 
  transmute(
    Country = B_COUNTRY_ALPHA,
    Feeling_of_happiness = V11,
    Life_satisfaction = V81,
    Financial_satisfaction = V80,
    Sex = V223,
    Age = V225,
    Year = V246)
```


- 2005
```{r}
happiness_2005 <- happiness2005%>%
   transmute(
    CountryCode = V2,
    Feeling_of_happiness = V10,
    Life_satisfaction = V22,
    Financial_satisfaction = V68,
    Sex = V235,
    Age = V237,
    Year = V260)
```

- 2010
```{r}
happiness_2010 <-happiness2010%>%
   transmute(
    Country = C_COW_ALPHA, 
    Feeling_of_happiness = V10,
    Life_satisfaction = V23,
    Financial_satisfaction = V59,
    Sex = V240,
    Age = V242,
    Year = V262)
  
```

- 2017
```{r}
happiness_2017 <- happiness2017%>%
  transmute(
    Country = C_COW_ALPHA,
    Feeling_of_happiness = Q46,
    Life_satisfaction = Q49,
    Financial_satisfaction = Q50,
    Sex = Q260,
    Age = Q262,
    Year = J_INTDATE)

```

-Fixing the date format in 2017 table. 
```{r}
# Convert the column to a date object
happiness_2017$Year <- as.Date(as.character(happiness_2017$Year), format = "%Y%m%d")

# Extract the year from the date column
happiness_2017$Year <- format(happiness_2017$Year, "%Y")
```

-Merging the happiness datasets. 

```{r}
# Merge tables with the same column names
merged_tables_1 <- rbind(happiness_1990, happiness_1995, happiness_2005)
merged_tables_1
```

```{r}
merged_tables_2 <- rbind(happiness_1999, happiness_2010, happiness_2017)
merged_tables_2
```

```{r}
# Add a missing column to merged_tables_1
merged_tables_1$Country <- NA
merged_tables_2$CountryCode <- NA
```


```{r}
# Merge the tables
happiness_tables <- rbind(merged_tables_2, merged_tables_1)

# Print the merged table
happiness_tables
```

```{r}
unique(happiness_tables$Country)
```

```{r}
# Drop duplicates based on all columns
happiness_tables <- subset(happiness_tables, select = -CountryCode)
```

```{r}
# Rename the column
happiness_tables <- rename(happiness_tables, CountryCode = Country)

# View the data frame with the renamed column
print(happiness_tables)
```


```{r}
happiness_tables %>% count(Life_satisfaction, sort = TRUE)
```


```{r}
happiness_tables %>% count(Feeling_of_happiness, sort = TRUE)
```

```{r}
happiness_tables %>% count(Financial_satisfaction, sort = TRUE)
```


- Deleting unnecesary values from the Survey data. 
```{r}
# Filter rows based on specific values across all columns
filtered_happiness <- happiness_tables %>%
  filter(across(everything(), ~ !(. %in% c("-1", "-2", "-3", "-4", "-5")), .names = "any_vars({.col})"))

# View the filtered data
print(filtered_happiness)
```

- Basic EDA on Happiness. 
```{r}
filtered_happiness %>% count(Feeling_of_happiness, sort = TRUE)
```

```{r}
Really_satisfied <- filtered_happiness %>% filter(Life_satisfaction >= 5 & Life_satisfaction <= 10)
```

```{r}
Really_happy <- filtered_happiness %>% filter(Feeling_of_happiness >= 1 & Feeling_of_happiness <= 2)
```

```{r}
sum_by_year <- filtered_happiness %>% 
  group_by(Year) %>% 
  summarize(sum_LS = sum(Life_satisfaction))

print(sum_by_year)
```


```{r}
# Histogram of Feeling_of_happiness
ggplot(filtered_happiness, aes(x = Feeling_of_happiness)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black") +
  labs(x = "Feeling of Happiness", y = "Count")
```
```{r}
# Histogram of Feeling_of_happiness
ggplot(filtered_happiness, aes(x = Life_satisfaction)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black") +
  labs(x = "Life Satisfaction", y = "Count")

```

```{r}
ggplot(filtered_happiness, aes(x = Financial_satisfaction)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black") +
  labs(x = "Financial Satisfaction", y = "Count")
```


```{r}
# Create a bar plot
ggplot(sum_by_year, aes(x = Year, y = sum_LS)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Year", y = "Sum of Life Satisfaction") +
  ggtitle("Sum of Life Satisfaction by Year")
```

```{r}
# Group the filtered data by country and calculate the sum of Life_satisfaction
sum_by_country <- filtered_happiness %>% group_by(CountryCode) %>% summarize(sum_LS = sum(Life_satisfaction))

print(sum_by_country)
```

```{r}
sum_by_age <- filtered_happiness %>% group_by(Age) %>% summarize(sum_LS = sum(Life_satisfaction))

print(sum_by_age)
```
```{r}
sum_by_sex <- filtered_happiness %>% group_by(Sex) %>% summarize(sum_LS = sum(Life_satisfaction))

print(sum_by_sex)
```

- Ready to merge population and happiness tables to be able to find correlation between data.
```{r}
filtered_happiness
```


```{r}
Population_total <- Population_total%>%
  select(-c("Year"))
```


- Starting to prepare the map. 

The following code is merging the population info table with happiness info table. 

- Now is time to merge the data for the map. 

- Clean geolocation data 

```{r}
countries_code
```

```{r}
countries_code <- countries_code%>%
  select(-c("country"))
```

```{r}
colnames(countries_code) <- c("Latitude", "Longitude", "Country")
countries_code
```

```{r}
country_codes <- country_codes%>%
  select(-c("A2 (ISO)", "NUM (UN)", "DIALING CODE"))
```

```{r}
colnames(country_codes) <- c("Country", "CountryCode")
country_codes <- merge(countries_code, country_codes, by = "Country")

country_codes
```

```{r}
world_countries <- world_countries %>%
  select(-c("FID", "ISO", "COUNTRYAFF","AFF_ISO"))
world_countries
```

```{r}
colnames(world_countries) <- c("Country", "Length", "Area")
world_countries
```

```{r}
colnames(regions) <- c("Country", "CountryCode", "Year", "Region")
```


```{r}
regions 
```

```{r}
region <- left_join(regions, countries_code, by = "Country")

region
```

```{r}
region <- left_join(region, world_countries, by= "Country")

region
```
```{r}
region <- region %>%
  select(-c("Year"))
```


```{r}
# Merge filtered_happiness and region by CountryCode
region_happiness <- left_join(filtered_happiness, region, by.x = "Country", by.y = "CountryCode", all.x = TRUE)
all_happiness <- left_join(region_happiness, Population_total, by = c("CountryCode", "Country"), all.x = TRUE)
```

```{r}
all_happiness
```


```{r}
unique(region_happiness$Country)
```

```{r}
all_happiness <- drop_na(drop_na(all_happiness))
```


- Creating a table for the map. 

```{r}
mean_copy <- all_happiness %>%
  group_by(CountryCode) %>%
  summarise(mean_feeling_of_happiness = mean(Feeling_of_happiness),
            mean_life_satisfaction = mean(Life_satisfaction),
            mean_financial_satisfaction = mean(Financial_satisfaction),
            .groups = "drop")
```
```{r}
# Remove duplicates and select only necessary columns
#mean_copy <- drop_na(mean_copy, Country)

mean_copy
```

```{r}
#merged_data <- merge(mean_copy, Population_total, by = "CountryCode", all = TRUE)
mean_data <- merge(merged_data, region, by = c("CountryCode", "Country"), all.x = TRUE)
```

```{r}
mean_data <- drop_na(drop_na(mean_data))
```

```{r}
mean_data
```

```{r}
unique(mean_data$Country)
```

```{r}
plot_table <- filtered_happiness %>%
  group_by(CountryCode) %>%
  summarise(mean_feeling_of_happiness = mean(Feeling_of_happiness),
            mean_life_satisfaction = mean(Life_satisfaction),
            mean_financial_satisfaction = mean(Financial_satisfaction),
            .groups = "drop")
```

```{r}
# Remove duplicates and select only necessary columns
plot_table <- drop_na(plot_table)

plot_table
```

```{r}
plot_2 <- merged_data
plot_2
```

```{r}
plot_2 <- drop_na(drop_na(plot_table))
```


```{r}
happiness_plot <- read_csv("Happiness_levels.csv")
```

```{r}
happiness_plot <- happiness_plot%>% 
  select(-c(Length,Area, geometry))

happiness_plot
```

```{r}
happiness_plot%>%
  filter(Feeling_of_happiness >= 1 & Feeling_of_happiness <= 2) %>%
      ggplot(aes(x = Feeling_of_happiness, y = Region, fill = factor(Region))) +
      geom_bar(stat = "identity") +
      labs(x = "Feeling of Happiness", y = "Count") +
      theme_minimal()

```

```{r}
happiness_year <- happiness_plot %>%
  filter(Feeling_of_happiness >= 1 & Feeling_of_happiness <= 2) %>%
  group_by(Year) %>%
  summarise(col_mean = mean(Feeling_of_happiness))%>%
  arrange(Year)

ggplot(happiness_year, aes(x = Year, y = col_mean, color = Year)) +
  geom_point(size = 5) +
  xlab("Year") +
  ylab("Happiness")
```

```{r}
happiness_year_age <- happiness_plot %>%
  group_by(Age) %>%
  summarise(col_mean = mean(Feeling_of_happiness))

ggplot(happiness_year_age, aes(x = Age, y = col_mean, color = Age)) +
  geom_point(size = 2) +
  xlab("Age") +
  ylab("Happiness") 
```



```{r}
happiness_year_age <- happiness_plot %>%
  filter(Feeling_of_happiness >= 1 & Feeling_of_happiness <= 2) %>%
  group_by(Age) %>%
  summarise(col_mean = mean(Feeling_of_happiness))

ggplot(happiness_year_age, aes(x = Age, y = col_mean, color = Age)) +
  geom_point(size = 3) +
  xlab("Age") +
  ylab("Happiness") 
```



```{r}
happiness_year_sex <- happiness_plot %>%
  filter(Feeling_of_happiness >= 1 & Feeling_of_happiness <= 2) %>%
  group_by(Year, Sex) %>%
  summarise(col_mean = mean(Feeling_of_happiness))

ggplot(happiness_year_sex, aes(x = Year, y = col_mean, color = as.factor(Sex))) +
  geom_point(size = 5) +
  xlab("Year") +
  ylab("Happiness")
```

```{r}
happiness_year_sex <- happiness_plot %>%
      filter(Feeling_of_happiness >= 1 & Feeling_of_happiness <= 2) %>%
      group_by(Sex) %>%
      summarise(Happiness = sum(Feeling_of_happiness),
                Life_satisfaction = sum(Life_satisfaction), .groups = "drop") 
     # filter(Sex == input$sexInput, Year == input$yearInput)

 p <- ggplot(data = happiness_year_sex, aes(x = Life_satisfaction, y = Happiness, fill = factor(Sex))) +
      geom_bar(stat = "identity", position = position_dodge(), colour = "black") +
      scale_fill_manual(values = c("#999999", "#E69F00"))
    
    ggplotly(p)
```

```{r}
lmAge <- all_happiness%>%
  lm(Feeling_of_happiness~Age, data = .)
  summary(lmAge)
```
```{r}
lmSex <- filtered_happiness%>%
  lm(Feeling_of_happiness~Sex, data = .)
  summary(lmSex)
```
```{r}
lm_sex_age <- region_happiness%>%
  lm(Feeling_of_happiness ~ Sex + Age + CountryCode, data = .)
  summary(lm_sex_age)
```



```{r}
 country_plot <- region_happiness %>%
      slice_max(Country, n=50)%>%
      group_by(Country)%>%
      summarize(Rate = weighted.mean(Feeling_of_happiness))%>%
      
      ggplot(aes(x=Country, y=Feeling_of_happiness, size=Rate, fill=Country)) +
      theme(axis.text.x=element_text(color = "black", size=10, angle=30, vjust=.9, hjust=0.8))+
      geom_point(alpha=0.5, shape=21, color="black") +
      scale_size(range = c(.1, 15), name="Death Rates per Continent")+
      ylab("cause of death") +
      xlab("Continent") +
      theme(legend.position = "right",
            legend.title = element_text(colour = "black", size = 5, face = "bold"),
            legend.text = element_text(colour = "black", size = 5),
            legend.key = element_blank(),
            legend.key.size = unit(0.6, "cm"))

 country_plot
```


```{r}
#write.csv(unhappiness, "unhappiness.csv")
```

